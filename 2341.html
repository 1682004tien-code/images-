<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ant Attack - Mobile Optimized</title>
    <style>
      body {
        margin: 0;
        cursor: grab;
        touch-action: none; 
        overflow: hidden;
        background: #000;
      }
      canvas {
        display: block;
      }
    </style>
  </head>
  <body>
    
    <script>
      'use strict';

      const a = document.body.appendChild(document.createElement('canvas'));
      const c = a.getContext("2d");
      
      const resize = () => {
        a.width = innerWidth;
        a.height = innerHeight;
      };
      window.onresize = resize;
      resize();

      const MAX_ANT_COUNT = 100;
      const HALF_ANT_COUNT = MAX_ANT_COUNT/2|0;
      const QUART_ANT_COUNT = MAX_ANT_COUNT/4|0;

      let i, j, k, l,
      objects, objectCount, score, totalScore, canvasBack, contextBack,

      hsl = (s=0, l=0, a=1)=> contextBack.fillStyle = c.fillStyle = `hsl(0,${s}%,${l}%,${a}`,

      drawAnt = (p, context)=>
      {
          for(i=3; i--;)
          {
              hsl(0, 0, .2);
              p.v && context.beginPath(context.fill(context.ellipse(
                  p.x, p.y+p.r/4, 
                  p.r*(.5-i/6), p.r*(1.3-i/6), 
                  p.a, 0, 9)));

              hsl();
              context.beginPath(context.fill(context.ellipse(
                  p.x, p.y, 
                  p.r/.6, p.r/15, 
                  p.a+Math.sin(i*2+p.d/13), 0, 9)));
          }
          for(i=3; i--;)
          {
              hsl(50, 9);
              context.beginPath(context.fill(context.ellipse(
                  p.x-p.r*Math.sin(p.a)*(i-1.4), p.y+p.r*(Math.cos(p.a)*(i-1.4))-p.r/4, 
                  p.r*(i-1?.4:.2), p.r*(i?.8:.4), 
                  p.a, 0, 9)));
          }
      },

      spawnObject = ()=>
      {
          objects.push(
          {
              x: ++objectCount%2 ? a.width*Math.random() : Math.random() < .5 ? -50 : a.width + 50,
              y: objectCount%2 ? Math.random() < .5 ? -50 : a.height + 50 : a.height*Math.random(),
              r:  objectCount > QUART_ANT_COUNT ? 
                  5+Math.random()*6 : 
                  7+Math.random()*3,
              v: Math.random()+1,
              a: 0,
              d: 0
          });
      },

      update = ()=>
      {
          a.width += 0;
          objects.map(p=>
          {
              if (p.v)
              {
                  p.x += p.v * Math.sin(p.a += (Math.random()*2-1)*.03);
                  p.y -= p.v * Math.cos(p.a += (Math.random()*2-1)*.03);
                  p.d += p.v -= p.v > 2 && .002;

                  if (p.x < -15) p.a = Math.random()*2-1 + 33;
                  if (p.x > a.width+15) p.a = Math.random()*2-1 - 33;
                  if (p.y < -15) p.a = Math.random()*2-1 + 22;
                  if (p.y > a.height+15) p.a = Math.random()*2-1;

                  drawAnt(p, c);
              }
          });

          c.font = '6em cursive';
          for(i=9; i--;)
          {
              hsl(99, 50-i*9);
              score && c.fillText(totalScore, 29+i, 99+i);
          }
      }

      a.before(canvasBack = a.cloneNode(a.style.position = 'absolute'));
      contextBack = canvasBack.getContext("2d");

      const initBackground = () => {
        for(i=99; i--;)
        for(j=99; j--;)
        for(l=99-Math.random()*15, k=9; k--;)
        {
            hsl(objectCount = score = totalScore = 0, l - k*3);
            contextBack.fillRect(i*99-k/6, j*99-k/6, 91+k, 91+k);
        }
      }
      initBackground();

      objects = [];
      spawnObject();

      const interact = (ex, ey) => {
          // Bổ sung: Lấy tọa độ tương đối so với canvas để chuẩn xác trên mobile
          const rect = a.getBoundingClientRect();
          const x = ex - rect.left;
          const y = ey - rect.top;

          objects.map(p=>
          {
              // Tăng nhẹ vùng chạm (p.r*3.5) để ngón tay dễ bấm hơn so với chuột
              if (p.v && Math.hypot(p.x - x, p.y - y) < p.r*3.5)
              {
                  p.v = 0;
                  ++totalScore;
                  if (++score == MAX_ANT_COUNT) objectCount = score = 0;

                  for(i = score ? score == HALF_ANT_COUNT ? MAX_ANT_COUNT : 2 : 1; i--;)
                      if (objectCount < HALF_ANT_COUNT | score == HALF_ANT_COUNT & objectCount < MAX_ANT_COUNT)
                          spawnObject();

                  for(i=29; i--;)
                  {
                      hsl(99, 50-Math.random()*20, .3);
                      contextBack.beginPath(contextBack.fill(contextBack.ellipse(
                          p.x+p.r*(Math.random()*2-1), p.y+p.r*(Math.random()*2-1), 
                          p.r*(Math.random()+1)/2, p.r*(Math.random()+1)/7, 
                          Math.random()*9, 0, 9)));
                  }
                  drawAnt(p, contextBack);
              }
              if (p.v && Math.hypot(p.x - x, p.y - y) < 150)
              {
                  p.v = Math.random()*3 + 2;
                  p.a = Math.atan2(p.x - x, y - p.y) + Math.random()*2-1;
              }
          });
      };

      // Đăng ký sự kiện dùng AddEventListener để ổn định hơn trên trình duyệt di động
      window.addEventListener('mousedown', e => interact(e.clientX, e.clientY));
      window.addEventListener('touchstart', e => {
          e.preventDefault();
          interact(e.touches[0].clientX, e.touches[0].clientY);
      }, { passive: false });

      setInterval(update, 16);
    </script>
  </body>
</html>